

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Efficient use of memory bandwidth on Betzy &mdash; Sigma2 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
      <link rel="stylesheet" type="text/css" href="../_static/nris.css?v=69e7a171" />
      <link rel="stylesheet" type="text/css" href="../_static/universal-navbar.css" />
      <link rel="stylesheet" type="text/css" href="../_static/statuspal.css" />

  
    <link rel="shortcut icon" href="../_static/nris.ico"/>
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../_static/doctools.js?v=9a2dae69"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script async="async" src="https://siteimproveanalytics.com/js/siteanalyze_6036825.js"></script>
      <script src="../_static/design-tabs.js?v=f930bc37"></script>
      <script src="../_static/statuspal_widget.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Efficient use of processors and network on Betzy" href="parallel-calculations.html" />
    <link rel="prev" title="Using MKL efficiently" href="mkl.html" /> 
</head>

<body class="wy-body-for-nav">
<!-- Send url to parent when displayed as iframe -->
<script>
    const valid_orign_url = "https://www.sigma2.no"
    window.addEventListener('message', function(event) {
        if (event.data === 'getDocumentationIframeUrl' && event.origin.startsWith(valid_orign_url)) {
            // path only (/path/example.html)
            const path = window.location.pathname
            // query string (including the initial ? symbol)
            const search = window.location.search
            // Returns the hash (including the initial # symbol)
            const hash = window.location.hash
            const newUrl = path + search + hash;
            event.source.postMessage(newUrl, event.origin)
        }
    })

</script>

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Sigma2/NRIS documentation
              <img src="../_static/NRIS Logo.svg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Policies</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../code-of-conduct.html">Code of Conduct</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Getting help</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../getting_help/support_line.html">Getting help</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_help/extended_support.html">Extended support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_help/faq.html">Frequently asked questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_help/how_to_write_good_support_requests.html">Writing good support requests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_help/qa-sessions.html">Open Question &amp; Answer Sessions for All Users</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_help/lost_forgotten_password.html">Lost, expiring or changing passwords</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_help/two_factor_authentication.html">One-time-pad (OTP) / Two-factor authentication</a></li>
<li class="toctree-l1"><a class="reference external" href="https://www.sigma2.no/project-leader-handbook">Project Leader Support</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Training</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../training/events.html">Training events</a></li>
<li class="toctree-l1"><a class="reference internal" href="../training/notes_qa.html">Questions, Answers and Feedbacks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../training/past_training.html">An overview over training events in the past</a></li>
<li class="toctree-l1"><a class="reference internal" href="../training/videos.html">Training Video Archives</a></li>
<li class="toctree-l1"><a class="reference internal" href="../training/short_instructions.html">Short Instructions Video Archives</a></li>
<li class="toctree-l1"><a class="reference internal" href="../training/material.html">Training materials</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/getting_started.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/opslog.html">Status and maintenance of systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/applying_account.html">How do I get an account?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/applying_resources.html">Applying for computing and storage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/file_transfer.html">File transfer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/editing_files.html">Editing files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../code_development/guides/vs_code/connect_to_server.html">Connecting to a system with Visual Studio Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/ssh.html">SSH</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/ssh.html#common-ssh-errors">Common SSH errors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/ood.html">Open OnDemand</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/R.html">First R calculation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Files, storage and backup</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../files_storage/nird_lmd.html">NIRD</a></li>
<li class="toctree-l1"><a class="reference internal" href="../files_storage/clusters.html">Storage areas on HPC clusters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../files_storage/quota.html">Storage quota</a></li>
<li class="toctree-l1"><a class="reference internal" href="../files_storage/backup.html">Backup on Betzy, Fram, Saga, and NIRD</a></li>
<li class="toctree-l1"><a class="reference internal" href="../files_storage/sharing_files.html">Data handling and storage policy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../files_storage/performance.html">Optimizing storage performance</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">HPC usage</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../hpc_machines/migration2metacenter.html">Migration to an NRIS HPC machine</a></li>
<li class="toctree-l1"><a class="reference internal" href="../computing/responsible-use.html">Using shared resources responsibly</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="overview.html">Running jobs</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="submitting.html">Submitting jobs</a></li>
<li class="toctree-l2"><a class="reference internal" href="choosing_job_types.html">Job Types</a></li>
<li class="toctree-l2"><a class="reference internal" href="job_scripts/array_jobs.html">Array Jobs</a></li>
<li class="toctree-l2"><a class="reference internal" href="job_scripts.html">Job Scripts</a></li>
<li class="toctree-l2"><a class="reference internal" href="monitoring.html">Monitoring jobs</a></li>
<li class="toctree-l2"><a class="reference internal" href="slurm_output.html">Understanding the job output file</a></li>
<li class="toctree-l2"><a class="reference internal" href="choosing-memory-settings.html">How to choose the right amount of memory</a></li>
<li class="toctree-l2"><a class="reference internal" href="choosing-number-of-cores.html">How to choose the number of cores</a></li>
<li class="toctree-l2"><a class="reference internal" href="common_job_failures.html">Common job failures</a></li>
<li class="toctree-l2"><a class="reference internal" href="performance.html">How to check the performance and scaling using Arm Performance Reports</a></li>
<li class="toctree-l2"><a class="reference internal" href="mkl.html">Using MKL efficiently</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Efficient use of memory bandwidth on Betzy</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#memory-numa-and-ccnuma">Memory - NUMA and ccNUMA</a></li>
<li class="toctree-l3"><a class="reference internal" href="#detailed-information-about-numa-nodes">Detailed information about NUMA nodes</a></li>
<li class="toctree-l3"><a class="reference internal" href="#binding-thread-processes-to-cores">Binding thread/processes to cores</a></li>
<li class="toctree-l3"><a class="reference internal" href="#monitoring-thread-process-placement">Monitoring thread/process placement</a></li>
<li class="toctree-l3"><a class="reference internal" href="#memory-bandwidth-sensitive-mpi-applications">Memory bandwidth sensitive MPI applications</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="parallel-calculations.html">Efficient use of processors and network on Betzy</a></li>
<li class="toctree-l2"><a class="reference internal" href="interactive_jobs.html">Interactive jobs</a></li>
<li class="toctree-l2"><a class="reference internal" href="checkpointing.html">Checkpointing Jobs</a></li>
<li class="toctree-l2"><a class="reference internal" href="projects_accounting.html">Projects and accounting</a></li>
<li class="toctree-l2"><a class="reference internal" href="scratchfiles.html">Local storage for scratch files</a></li>
<li class="toctree-l2"><a class="reference internal" href="guides.html">Guides</a></li>
<li class="toctree-l2"><a class="reference internal" href="slurm_commands.html">Useful Slurm commands and tools for managing jobs</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="internet-login-compute-nodes.html">Login nodes:</a></li>
<li class="toctree-l1"><a class="reference internal" href="internet-login-compute-nodes.html#compute-nodes">Compute nodes:</a></li>
<li class="toctree-l1"><a class="reference internal" href="../computing/tuning-applications.html">Tuning applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../code_development/guides_llm.html">Running LLM Models in a Cluster Environment</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Compute resources</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../hpc_machines/hardware_overview.html">Overview over our machines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hpc_machines/betzy.html">Betzy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hpc_machines/fram.html">Fram</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hpc_machines/olivia.html">Olivia</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hpc_machines/saga.html">Saga</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hpc_machines/lumi.html">LUMI</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Software</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../software/modulescheme.html">Software module scheme</a></li>
<li class="toctree-l1"><a class="reference internal" href="../software/installed_software.html">Installed software</a></li>
<li class="toctree-l1"><a class="reference internal" href="../software/userinstallsw.html">Installing software as user</a></li>
<li class="toctree-l1"><a class="reference internal" href="../software/appguides.html">Application guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../software/licenses.html">Licence and access policies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../software/eessi.html">EESSI</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Additional services</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../nird_archive/sandbox-user-guide.html">NIRD Research Data Archive Sandbox (NIRD RDA sandbox)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../nird_archive/user-guide.html">NIRD Research Data Archive (NIRD RDA)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../nird_toolkit/overview.html">NIRD Toolkit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../nird_service_platform/overview_nird_service_platform.html">NIRD Service Platform</a></li>
<li class="toctree-l1"><a class="reference internal" href="../services/easydmp-user-documentation.html">EasyDMP User Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_help/course_resources.html">CRaaS - Course Resources as a Service</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Code development and tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../code_development/overview.html">Code development and tutorials</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Sigma2/NRIS documentation</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="overview.html">Running jobs</a></li>
      <li class="breadcrumb-item active">Efficient use of memory bandwidth on Betzy</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="efficient-use-of-memory-bandwidth-on-betzy">
<h1>Efficient use of memory bandwidth on Betzy<a class="headerlink" href="#efficient-use-of-memory-bandwidth-on-betzy" title="Link to this heading"></a></h1>
<section id="memory-numa-and-ccnuma">
<h2>Memory - NUMA and ccNUMA<a class="headerlink" href="#memory-numa-and-ccnuma" title="Link to this heading"></a></h2>
<p>Betzy compute node is a 2-socket system running AMD EPYC 7742 64-Core
processors.  Each compute node on Betzy has 256 GiB of memory, organised in 8
banks of 32 GiB each. Every processor has four memory controllers, each
responsible for one bank. Furthermore, every virtual core in a processor is
assigned to one memory controller which results in different paths to access
memory. Memory accesses may have to traverse an intra-processor network
(another controller within the same processor is responsible for the memory
address being accessed) or an intra-node network (another controller of the
other processor is responsible for the memory address being accessed). This
memory organisation is referred to as non uniform memory access (NUMA) memory.</p>
<p>This means that although all CPU cores can access all RAM, <strong>the speed of the
access will differ: some memory pages are closer to each CPU, and some are
further away</strong>. In contrast to a similar Intel-based system, where each socket
is one NUMA node, Betzy has 4 NUMA nodes per socket, and 8 in total.</p>
<p>A NUMA node comprises of a memory bank and a subset of the virtual cores. The
best performance is achieved when processes and the memory they access
(frequently) are placed close to each other, or in other words, within one NUMA
node.</p>
<p>Additionally, the compute nodes implement cache coherent NUMA (ccNUMA) memory
which ensures that programs see a consistent memory image. Cache coherence
requires intra-node communication if different caches store the same memory
location.  Hence, the best performance is achieved when the same memory
location is not stored in different caches. Typically this happens when
processes need access to some shared data, e.g. at boundaries of regions they
iterate over. Limiting or even avoiding these accesses is often a challenge.</p>
</section>
<section id="detailed-information-about-numa-nodes">
<h2>Detailed information about NUMA nodes<a class="headerlink" href="#detailed-information-about-numa-nodes" title="Link to this heading"></a></h2>
<p>More detailed information about the NUMA
architecture can be obtained as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ numactl -H

available: 8 nodes (0-7)
node 0 cpus: 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143
node 0 size: 32637 MB
node 0 free: 30739 MB
node 1 cpus: 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159
node 1 size: 32767 MB
node 1 free: 31834 MB
node 2 cpus: 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175
node 2 size: 32767 MB
node 2 free: 31507 MB
node 3 cpus: 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191
node 3 size: 32755 MB
node 3 free: 31489 MB
node 4 cpus: 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207
node 4 size: 32767 MB
node 4 free: 31746 MB
node 5 cpus: 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223
node 5 size: 32767 MB
node 5 free: 31819 MB
node 6 cpus: 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239
node 6 size: 32767 MB
node 6 free: 31880 MB
node 7 cpus: 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255
node 7 size: 32767 MB
node 7 free: 31805 MB
node distances:
node   0   1   2   3   4   5   6   7
  0:  10  12  12  12  32  32  32  32
  1:  12  10  12  12  32  32  32  32
  2:  12  12  10  12  32  32  32  32
  3:  12  12  12  10  32  32  32  32
  4:  32  32  32  32  10  12  12  12
  5:  32  32  32  32  12  10  12  12
  6:  32  32  32  32  12  12  10  12
  7:  32  32  32  32  12  12  12  10
</pre></div>
</div>
</section>
<section id="binding-thread-processes-to-cores">
<h2>Binding thread/processes to cores<a class="headerlink" href="#binding-thread-processes-to-cores" title="Link to this heading"></a></h2>
<p>The above picture is further complicated by the fact that within the individual
NUMA nodes the memory access time is also not uniform. This can be verified by
running the <a class="reference external" href="https://github.com/jeffhammond/STREAM">STREAM benchmark</a>. As
reported above, each NUMA node has 16 physical cores (e.g. node 0, cores 0-15).</p>
<p>Consider the following 2 STREAM experiments:</p>
<ol class="arabic simple">
<li><p>start 8 threads, bind them to cores 0-8</p></li>
<li><p>start 8 threads, bind them to cores 0,2,4,6,8,10,12,14</p></li>
</ol>
<p>In terms of the OMP_PLACES directive the above is equivalent to:</p>
<ol class="arabic simple">
<li><p>OMP_PLACES=”{0:1}:8:1” OMP_NUM_THREADS=8 ./stream</p></li>
<li><p>OMP_PLACES=”{0:1}:8:2” OMP_NUM_THREADS=8 ./stream</p></li>
</ol>
<p>On a standard Intel-based system the above two experiments would perform
identically. This is not the case on Betzy: the first approach is slower than the
second one:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Experiment</p></th>
<th class="head"><p>Function</p></th>
<th class="head"><p>Best Rate MB/s</p></th>
<th class="head"><p>Avg time</p></th>
<th class="head"><p>Min time</p></th>
<th class="head"><p>Max time</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>1</p></td>
<td><p>Copy</p></td>
<td><p>37629.4</p></td>
<td><p>0.212833</p></td>
<td><p>0.212600</p></td>
<td><p>0.213007</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>Triad</p></td>
<td><p>35499.6</p></td>
<td><p>0.338472</p></td>
<td><p>0.338032</p></td>
<td><p>0.338771</p></td>
</tr>
<tr class="row-even"><td><p>2</p></td>
<td><p>Copy</p></td>
<td><p>42128.7</p></td>
<td><p>0.190025</p></td>
<td><p>0.189894</p></td>
<td><p>0.190152</p></td>
</tr>
<tr class="row-odd"><td><p>2</p></td>
<td><p>Triad</p></td>
<td><p>41844.4</p></td>
<td><p>0.287000</p></td>
<td><p>0.286777</p></td>
<td><p>0.287137</p></td>
</tr>
</tbody>
</table>
<p>This shows that the memory access time is not uniform within a single NUMA node.</p>
<p>Interestingly, the peak achievable memory bandwidth also depends on the number
of cores used, and is maximized for lower core counts. This is confirmed by the
following STREAM experiments running on one NUMA node:</p>
<ol class="arabic simple">
<li><p>start 8 threads, bind them to cores 0,2,4,6,8,10,12,14</p></li>
<li><p>start 16 threads, bind them to cores 0-15</p></li>
</ol>
<p>In terms of the OMP_PLACES directive the above is equivalent to:</p>
<ol class="arabic simple">
<li><p>OMP_PLACES=”{0:1}:8:2” OMP_NUM_THREADS=8 ./stream</p></li>
<li><p>OMP_PLACES=”{0:1}:16:1” OMP_NUM_THREADS=16 ./stream</p></li>
</ol>
<p>The results are:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Experiment</p></th>
<th class="head"><p>Function</p></th>
<th class="head"><p>Best Rate MB/s</p></th>
<th class="head"><p>Avg time</p></th>
<th class="head"><p>Min time</p></th>
<th class="head"><p>Max time</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>1</p></td>
<td><p>Copy</p></td>
<td><p>42126.3</p></td>
<td><p>0.190034</p></td>
<td><p>0.189905</p></td>
<td><p>0.190177</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>Triad</p></td>
<td><p>41860.1</p></td>
<td><p>0.287013</p></td>
<td><p>0.286669</p></td>
<td><p>0.287387</p></td>
</tr>
<tr class="row-even"><td><p>2</p></td>
<td><p>Copy</p></td>
<td><p>39675.8</p></td>
<td><p>0.201817</p></td>
<td><p>0.201634</p></td>
<td><p>0.201950</p></td>
</tr>
<tr class="row-odd"><td><p>2</p></td>
<td><p>Triad</p></td>
<td><p>39181.7</p></td>
<td><p>0.306733</p></td>
<td><p>0.306265</p></td>
<td><p>0.307508</p></td>
</tr>
</tbody>
</table>
<p>The above test demonstrates that memory bandwidth is maximized when using 8 out of 16 cores per NUMA node.</p>
<p>The following experiments test the entire system:</p>
<ol class="arabic simple">
<li><p>start 64 threads, bind them to cores 0,2,…126</p></li>
<li><p>start 128 threads, bind them to cores 0,1,..127</p></li>
</ol>
<p>In terms of the OMP_PLACES directive the above is equivalent to:</p>
<ol class="arabic simple">
<li><p>OMP_PLACES=”{0:1}:64:2” OMP_NUM_THREADS=64 ./stream</p></li>
<li><p>OMP_PLACES=”{0:1}:128:1” OMP_NUM_THREADS=128 ./stream</p></li>
</ol>
<p>The results are:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Experiment</p></th>
<th class="head"><p>Function</p></th>
<th class="head"><p>Best Rate MB/s</p></th>
<th class="head"><p>Avg time</p></th>
<th class="head"><p>Min time</p></th>
<th class="head"><p>Max time</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>1</p></td>
<td><p>Copy</p></td>
<td><p>334265.8</p></td>
<td><p>0.047946</p></td>
<td><p>0.047866</p></td>
<td><p>0.048052</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>Triad</p></td>
<td><p>329046.7</p></td>
<td><p>0.073018</p></td>
<td><p>0.072938</p></td>
<td><p>0.073143</p></td>
</tr>
<tr class="row-even"><td><p>2</p></td>
<td><p>Copy</p></td>
<td><p>315216.0</p></td>
<td><p>0.050855</p></td>
<td><p>0.050759</p></td>
<td><p>0.050926</p></td>
</tr>
<tr class="row-odd"><td><p>2</p></td>
<td><p>Triad</p></td>
<td><p>309893.4</p></td>
<td><p>0.077549</p></td>
<td><p>0.077446</p></td>
<td><p>0.077789</p></td>
</tr>
</tbody>
</table>
<p>Hence on Betzy <strong>memory bandwidth hungry applications will likely benefit from only using half of the cores (64)</strong>.</p>
<p>Note however that it is not enough to just use 64 cores instead of 128. <strong>It is
important to bind the threads/ranks to cores correctly</strong>, i.e., to run on every
second core. So a correct binding is either 0,2,4,…,126, or 1,3,5,…,127.
The above assures that the application runs on both NUMA-nodes in the most
efficient way. If instead you run the application on cores 0-63 only, then it
will be running at 50% performance as only one NUMA node will be used.</p>
</section>
<section id="monitoring-thread-process-placement">
<h2>Monitoring thread/process placement<a class="headerlink" href="#monitoring-thread-process-placement" title="Link to this heading"></a></h2>
<p>To monitor the placement of threads or processes/ranks the <code class="docutils literal notranslate"><span class="pre">htop</span></code> utility is
useful, just log in to a node running your application and issue the <code class="docutils literal notranslate"><span class="pre">htop</span></code>
command. By default  <code class="docutils literal notranslate"><span class="pre">htop</span></code> numbers the cores from 1 through 256. This can be
confusing at times (it can be changed in htop by pressing F2 and navigate to
display options and tick off count from zero).</p>
<p>The 0-127 (counting starts from zero) are the first one of the two SMT on the
AMD processor. The number of cores from 128 to 255 are the second SMT thread
and share the same executional units as do the first 128 cores.</p>
<p>Using this view it’s easy to monitor how the ranks and threads are allocated
and mapped on the compressor cores.</p>
</section>
<section id="memory-bandwidth-sensitive-mpi-applications">
<h2>Memory bandwidth sensitive MPI applications<a class="headerlink" href="#memory-bandwidth-sensitive-mpi-applications" title="Link to this heading"></a></h2>
<p>Some MPI applications are very sensitive to memory bandwidth
and consequently will benefit from having fewer ranks per node than the number
of cores, like running only 64 ranks per node.</p>
<p>Using <code class="docutils literal notranslate"><span class="pre">#SBATCH</span> <span class="pre">--ntasks-per-node=64</span></code> and then launch using something like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mpirun</span> <span class="o">--</span><span class="nb">map</span><span class="o">-</span><span class="n">by</span> <span class="n">slot</span><span class="p">:</span><span class="n">PE</span><span class="o">=</span><span class="mi">2</span> <span class="o">--</span><span class="n">bind</span><span class="o">-</span><span class="n">to</span> <span class="n">core</span> <span class="o">./</span><span class="n">a</span><span class="o">.</span><span class="n">out</span>
<span class="n">mpirun</span> <span class="o">--</span><span class="nb">map</span><span class="o">-</span><span class="n">by</span> <span class="n">ppr</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="n">socket</span><span class="p">:</span><span class="n">pe</span><span class="o">=</span><span class="mi">2</span> <span class="o">--</span><span class="n">bind</span><span class="o">-</span><span class="n">to</span> <span class="n">core</span> <span class="o">./</span><span class="n">a</span><span class="o">.</span><span class="n">out</span>
</pre></div>
</div>
<p>Tests have shown that more than 2x in performance is possible, but using twice
as many nodes. Twice the number of nodes will yield twice the aggregated
memory bandwidth. Needless to say also twice as many core hours.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="mkl.html" class="btn btn-neutral float-left" title="Using MKL efficiently" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="parallel-calculations.html" class="btn btn-neutral float-right" title="Efficient use of processors and network on Betzy" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Sigma2/NRIS. Text shared under CC-BY 4.0 license.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>