

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tuning applications &mdash; Sigma2 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=9edc463e" />
      <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
      <link rel="stylesheet" type="text/css" href="../_static/nris.css?v=69e7a171" />
      <link rel="stylesheet" type="text/css" href="../_static/universal-navbar.css" />
      <link rel="stylesheet" type="text/css" href="../_static/statuspal.css" />

  
    <link rel="shortcut icon" href="../_static/nris.ico"/>
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../_static/doctools.js?v=9a2dae69"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../_static/copybutton.js?v=f281be69"></script>
      <script async="async" src="https://siteimproveanalytics.com/js/siteanalyze_6036825.js"></script>
      <script src="../_static/design-tabs.js?v=f930bc37"></script>
      <script src="../_static/statuspal_widget.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Running LLM Models in a Cluster Environment" href="../code_development/guides_llm.html" />
    <link rel="prev" title="Login nodes:" href="../jobs/internet-login-compute-nodes.html" /> 
</head>

<body class="wy-body-for-nav">
<!-- Send url to parent when displayed as iframe -->
<script>
    const valid_orign_url = "https://www.sigma2.no"
    window.addEventListener('message', function(event) {
        if (event.data === 'getDocumentationIframeUrl' && event.origin.startsWith(valid_orign_url)) {
            // path only (/path/example.html)
            const path = window.location.pathname
            // query string (including the initial ? symbol)
            const search = window.location.search
            // Returns the hash (including the initial # symbol)
            const hash = window.location.hash
            const newUrl = path + search + hash;
            event.source.postMessage(newUrl, event.origin)
        }
    })

</script>

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Sigma2/NRIS documentation
              <img src="../_static/NRIS Logo.svg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Policies</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../code-of-conduct.html">Code of Conduct</a></li>
<li class="toctree-l1"><a class="reference external" href="https://www.sigma2.no/acceptable-use-policy">User Policy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/security-policy.html">Security policy for Sigma2 infrastructure</a></li>
<li class="toctree-l1"><a class="reference internal" href="../files_storage/sharing_files.html">Data handling and storage policy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../software/licenses.html">Licence and access policies</a></li>
<li class="toctree-l1"><a class="reference external" href="https://www.sigma2.no/data-policy">Data Policy</a></li>
<li class="toctree-l1"><a class="reference external" href="https://www.sigma2.no/data-decommissioning-policies">Data decommissioning policies</a></li>
<li class="toctree-l1"><a class="reference external" href="https://www.sigma2.no/central-data-library-policy">Central Data Library Policy</a></li>
<li class="toctree-l1"><a class="reference external" href="https://www.sigma2.no/policies">Overview of Sigma2 Policies</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Getting help</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../getting_help/support_line.html">Getting help</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_help/extended_support.html">Extended support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_help/faq.html">Frequently asked questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_help/how_to_write_good_support_requests.html">Writing good support requests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_help/qa-sessions.html">Open Question &amp; Answer Sessions for All Users</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_help/lost_forgotten_password.html">Lost, expiring or changing passwords</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_help/two_factor_authentication.html">One-time-pad (OTP) / Two-factor authentication</a></li>
<li class="toctree-l1"><a class="reference external" href="https://www.sigma2.no/project-leader-handbook">Project Leader Support</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Training</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../training/events.html">Training events</a></li>
<li class="toctree-l1"><a class="reference internal" href="../training/notes_qa.html">Questions, Answers and Feedbacks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../training/videos.html">Training Video Archives</a></li>
<li class="toctree-l1"><a class="reference internal" href="../training/short_instructions.html">Short Instructions Video Archives</a></li>
<li class="toctree-l1"><a class="reference internal" href="../training/material.html">Training materials</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/getting_started.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/opslog.html">Status and maintenance of systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/applying_account.html">How do I get an account?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/applying_resources.html">Applying for computing and storage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/file_transfer.html">File transfer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/editing_files.html">Editing files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../code_development/guides/vs_code/connect_to_server.html">Connecting to a system with Visual Studio Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/ssh.html">SSH</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/ssh.html#common-ssh-errors">Common SSH errors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/ood.html">Open OnDemand</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/R.html">First R calculation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Data and Storage Services</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../files_storage/nird/nird_dp.html">NIRD Data Peak</a></li>
<li class="toctree-l1"><a class="reference internal" href="../files_storage/nird/nird_dl.html">NIRD Data Lake</a></li>
<li class="toctree-l1"><a class="reference internal" href="../files_storage/nird/backup_lmd.html">NIRD Backup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../files_storage/nird/cdl.html">(NIRD) Central Data Library</a></li>
<li class="toctree-l1"><a class="reference internal" href="../nird_archive/user-guide.html">NIRD Research Data Archive (NIRD RDA)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../nird_service_platform/overview_nird_service_platform.html">NIRD Service Platform</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Storage Resources and Usage</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../files_storage/nird_lmd.html">NIRD</a></li>
<li class="toctree-l1"><a class="reference internal" href="../files_storage/clusters.html">Storage areas on HPC clusters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../files_storage/quota.html">Storage quota</a></li>
<li class="toctree-l1"><a class="reference internal" href="../files_storage/backup.html">Backup on Betzy, Saga, and NIRD</a></li>
<li class="toctree-l1"><a class="reference internal" href="../files_storage/performance.html">Optimizing storage performance</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">HPC usage</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../hpc_machines/migration2metacenter.html">Migration to an NRIS HPC machine</a></li>
<li class="toctree-l1"><a class="reference internal" href="responsible-use.html">Using shared resources responsibly</a></li>
<li class="toctree-l1"><a class="reference internal" href="../jobs/overview.html">Running jobs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../jobs/internet-login-compute-nodes.html">Login nodes:</a></li>
<li class="toctree-l1"><a class="reference internal" href="../jobs/internet-login-compute-nodes.html#compute-nodes">Compute nodes:</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Tuning applications</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="#scaling">Scaling</a></li>
<li class="toctree-l2"><a class="reference internal" href="#arm-performance-reports">ARM Performance reports</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#running-performance-reports">Running performance reports</a></li>
<li class="toctree-l3"><a class="reference internal" href="#header">Header</a></li>
<li class="toctree-l3"><a class="reference internal" href="#summary">Summary</a></li>
<li class="toctree-l3"><a class="reference internal" href="#details-cpu">Details - CPU</a></li>
<li class="toctree-l3"><a class="reference internal" href="#details-mpi">Details - MPI</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#arm-forge-map-tool">ARM forge Map tool</a></li>
<li class="toctree-l2"><a class="reference internal" href="#intel-advisor">Intel Advisor</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id1">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="#running-and-collecting">Running and collecting</a></li>
<li class="toctree-l3"><a class="reference internal" href="#display-survey">Display Survey</a></li>
<li class="toctree-l3"><a class="reference internal" href="#display-roof-line-model">Display Roof-line model</a></li>
<li class="toctree-l3"><a class="reference internal" href="#display-memory-access">Display Memory access</a></li>
<li class="toctree-l3"><a class="reference internal" href="#display-memory-dependencies">Display memory dependencies</a></li>
<li class="toctree-l3"><a class="reference internal" href="#program-efficiency">Program efficiency</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../code_development/guides_llm.html">Running LLM Models in a Cluster Environment</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Compute resources</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../hpc_machines/hardware_overview.html">Overview over our machines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hpc_machines/betzy.html">Betzy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hpc_machines/olivia.html">Olivia</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hpc_machines/saga.html">Saga</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hpc_machines/lumi.html">LUMI</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Software</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../software/modulescheme.html">Software module scheme</a></li>
<li class="toctree-l1"><a class="reference internal" href="../software/installed_software.html">Installed software</a></li>
<li class="toctree-l1"><a class="reference internal" href="../software/userinstallsw.html">Installing software as user</a></li>
<li class="toctree-l1"><a class="reference internal" href="../software/appguides.html">Application guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../software/eessi.html">EESSI</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tools and Additional services</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../nird_toolkit/overview.html">NIRD Toolkit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_help/course_resources.html">CRaaS - Course Resources as a Service</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Code development and tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../code_development/overview.html">Code development and tutorials</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Sigma2/NRIS documentation</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Tuning applications</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="tuning-applications">
<h1>Tuning applications<a class="headerlink" href="#tuning-applications" title="Link to this heading"></a></h1>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Link to this heading"></a></h2>
<p>Running scientific application in order to maximise the efficiency of
the hardware is increasingly important as the core count increase. A
system like Betzy with 172k cores represent a substantial cost and
efficiency of the applications run should be as high a practically
possible.</p>
<p>There are several steps with increasing complexity that can be taken
to learn more about the application’s behaviour. Starting from
checking the scaling to produce a roof line model of the application.
Digging deeper into the matter is also possible with even more
advanced usage of the tools and even more advanced tools.</p>
<p>A set of tools is presented, each with increasing complexity.</p>
<p>In this case study we’ll follow a real application called FVCOM which
is an ocean current simulation code. I typically run on 1024 cores,
not the application with the highest core count, but a typical example
of a seasoned well known application with it’s special traits.</p>
<p>In the following we will cover application tuning and benchmarking at a general level.
If you are interested in specific advice or guidance for your particular software, please
have a look at the <a class="reference internal" href="../software/appguides.html#appguides"><span class="std std-ref">application specific</span></a> pages, locate your application and see if it has a dedicated guide. If not,
and this is of interest to you, please consider contacting us by sending a mail to <a class="reference external" href="mailto:support&#37;&#52;&#48;nris&#46;no">support<span>&#64;</span>nris</a>. We
greatly appreciate any assistance or help in improving this.</p>
</section>
<section id="scaling">
<h2>Scaling<a class="headerlink" href="#scaling" title="Link to this heading"></a></h2>
<p>The scaling of an application is one of the key factors for running in
parallel. This simple metric is very simple to record. Just run the
application with an increasing number of cores and record the run time
(many ways exist to record run time, but <code class="docutils literal notranslate"><span class="pre">time</span> <span class="pre">-p</span> <span class="pre">mpirun</span> <span class="pre">&lt;executable&gt;</span></code>
is one of the simplest. As the speedup in many cases also depend on
the input data used it is important to run the scaling test with a
relevant input data set.</p>
<p>Plot the recorded run time as function of core used and look for trend in the run time,
alternatively plot the speedup from the lowest core count.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p># cores</p></th>
<th class="head"><p>run time</p></th>
<th class="head"><p>speedup</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>128</p></td>
<td><p>4071.89</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-odd"><td><p>256</p></td>
<td><p>2193.52</p></td>
<td><p>1.86</p></td>
</tr>
<tr class="row-even"><td><p>512</p></td>
<td><p>1173.19</p></td>
<td><p>3.47</p></td>
</tr>
<tr class="row-odd"><td><p>1024</p></td>
<td><p>659.38</p></td>
<td><p>6.18</p></td>
</tr>
<tr class="row-even"><td><p>2048</p></td>
<td><p>395.53</p></td>
<td><p>10.29</p></td>
</tr>
</tbody>
</table>
<figure class="align-default" id="id2">
<img alt="Scaling" src="../_images/Speedup.png" />
<figcaption>
<p><span class="caption-text">Fig. 1 - Scaling</span><a class="headerlink" href="#id2" title="Link to this image"></a></p>
</figcaption>
</figure>
<p>The plot show the recorded speedup for FVCOM with the current input data.
The dashed line represent perfect speedup.</p>
</section>
<section id="arm-performance-reports">
<span id="tuning-applications-apr"></span><h2>ARM Performance reports<a class="headerlink" href="#arm-performance-reports" title="Link to this heading"></a></h2>
<p>To learn a great deal of the application the tool
<code class="docutils literal notranslate"><span class="pre">Performance-reports</span></code> can be used.  This tool profile the application
and provide a one page report with a huge array of important metrics.</p>
<section id="running-performance-reports">
<h3>Running performance reports<a class="headerlink" href="#running-performance-reports" title="Link to this heading"></a></h3>
<p>The commands used to use and run the ARM performance reports and map are:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">module</span> <span class="n">load</span> <span class="n">Arm</span><span class="o">-</span><span class="n">Forge</span><span class="o">/</span><span class="mf">22.1.3</span> 
</pre></div>
</div>
<p>With some extra to fix the ARM-forge license server issues, the license server
have issues with the proxy settings. The prolog script environment variable (SLURM_TASK_PROLOG)
is needed if you want to run on multiple nodes as the local settings only apply for the current shell.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">unset</span> <span class="n">https_proxy</span> <span class="n">http_proxy</span>
<span class="n">export</span> <span class="n">https_proxy</span><span class="o">=</span><span class="s1">&#39;&#39;</span> <span class="n">http_proxy</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
<span class="n">export</span> <span class="n">SLURM_TASK_PROLOG</span><span class="o">=/</span><span class="n">cluster</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">Arm</span><span class="o">-</span><span class="n">Forge</span><span class="o">.</span><span class="n">prolog</span>
</pre></div>
</div>
<p>Now the license server should be accessible and we can launch the performance reporter.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>perf-report mpirun ./fvcom.bin --casename=$RUN &gt; $RUN_DIR/log-${SLURM_JOBID}.out
</pre></div>
</div>
<p>When the Slurm job is finished two files containing performance reports are found as:
<code class="docutils literal notranslate"><span class="pre">fvcom_1024p_8n_1t_yyyy-mm-dd_hh-mm.txt</span></code> and <code class="docutils literal notranslate"><span class="pre">fvcom_1024p_8n_1t_yyyy-mm-dd_hh-mm.html</span></code>.</p>
<p>See also <a class="reference internal" href="../jobs/performance.html#arm-performance-reports"><span class="std std-ref">How to check the performance and scaling using Arm Performance Reports</span></a>.</p>
<p>For extensive information please review the [Performance reports manual]
(https://developer.arm.com/documentation/101136/22-1-3/Performance-Reports).</p>
</section>
<section id="header">
<h3>Header<a class="headerlink" href="#header" title="Link to this heading"></a></h3>
<figure class="align-default" id="id3">
<img alt="Performance report header" src="../_images/Perf-reports-1.png" />
<figcaption>
<p><span class="caption-text">Fig. 2 - Performance report header</span><a class="headerlink" href="#id3" title="Link to this image"></a></p>
</figcaption>
</figure>
<p>The header give basic
information how the application was invoked and run. It also provide
total wall time. The figure to the right give a quick overview of how
the time is distributed over the categories of execution. This is
binned into 3 categories, compute time, time spent in MPI library and
time spent doing Input &amp; Output. In this example we see that time is
spent on doing computation and communication using MPI.</p>
</section>
<section id="summary">
<h3>Summary<a class="headerlink" href="#summary" title="Link to this heading"></a></h3>
<figure class="align-default" id="id4">
<img alt="Performance report summary" src="../_images/Perf-reports-2.png" />
<figcaption>
<p><span class="caption-text">Fig. 3 - Performance report summary</span><a class="headerlink" href="#id4" title="Link to this image"></a></p>
</figcaption>
</figure>
<p>The summary report
section contain a lot of useful information in just a few lines.  It
show us that only 69% of the time is spent doing computations. This
metric is important when we calculate the total efficiency of the
application.</p>
<p>The next entry teach us that the application spent 31% of the total
time doing communication using MPI. This is time spent as a
consequence of MPI functions needed to make a parallel program. This
number should be as low as possible as the time spend doing
communications is wasted compute cycles. About 1/3 of all compute
cycles in this run is wasted do to waiting for MPI functions t
complete.</p>
<p>The last entry show that FVCOM does very little Input &amp; Output during
a run. Other applications might have a far larger number here.</p>
</section>
<section id="details-cpu">
<h3>Details - CPU<a class="headerlink" href="#details-cpu" title="Link to this heading"></a></h3>
<figure class="align-default" id="id5">
<img alt="Performance report Details - CPU" src="../_images/Perf-reports-3.png" />
<figcaption>
<p><span class="caption-text">Fig. 4 - Performance report Details - CPU</span><a class="headerlink" href="#id5" title="Link to this image"></a></p>
</figcaption>
</figure>
<p>The CPU details
give us some hints about the actual CPU usage and the application
instructions and memory access.  This is a pure MPI application and
each rank is single core, hence 100% single core.</p>
<p>36% of the compute time is spend executing scalar numeric operations,
only 0.3% is spend executing vector operations. This is not good, as
the AMD Rome processors have AVX2 vector instructions capable of 256
bits, 4 double or 8 single precision of floating point operations in
one instruction. Using only scalar instructions mean that we are only
exploiting 1/4 or 1/8th of the total compute capacity of the
processor.</p>
<p>62% of the compute time is spent waiting for data to be moved to and
from memory into the processor. This is normally due to a limitation
of the memory bandwidth as is normally the case or poor programming
with a lot of random memory accesses. Poor memory bandwidth is a
common performance limitation. While the AMD Rome processors in Betzy
show memory bandwidth in excess of 300 Gbytes per second this is far
from enough to keep up with a processor running at 2500 MHz. Example,
300 Gbytes/s is 37 G double precision floats per second. A single core
can do 4 double precision operations per vector unit per clock or 2.5
GHz*4 = 10 Gflops/s. Then there are two vector units per core and 128
cores in total. The cache helps in data can be reused in several
calculations, but as the measurements show the bulk of time is spent
waiting for memory.</p>
<p>The comments below clearly indicate this as the application is memory
bound and very little time is spent in vectorised code.</p>
</section>
<section id="details-mpi">
<h3>Details - MPI<a class="headerlink" href="#details-mpi" title="Link to this heading"></a></h3>
<figure class="align-default" id="id6">
<img alt="Performance report Details - MPI" src="../_images/Perf-reports-4.png" />
<figcaption>
<p><span class="caption-text">Fig. 5 - Performance report Details - MPI</span><a class="headerlink" href="#id6" title="Link to this image"></a></p>
</figcaption>
</figure>
<p>The MPI details
informs us that of the time spent in communication the majority of the
MPI (63%) time is spent on doing collective operations, while the rest
is spent in point-to-point communication. The relatively high fraction
of time in collectives can be due to imbalance between the ranks. We
see that the transfer rate is only in single digit Mbytes/s and only
two digits for point-to-point. Very far from the wire speed at about
10 Gbytes/s.</p>
<figure class="align-default" id="id7">
<img alt="Performance report Details - IO" src="../_images/Perf-reports-5.png" />
<figcaption>
<p><span class="caption-text">Fig. 6 - Performance report Details - IO</span><a class="headerlink" href="#id7" title="Link to this image"></a></p>
</figcaption>
</figure>
<p>The IO details
show that FVCOM spent a very little time doing IO during a run. About equal
time for read and write. The transfer bandwidth is low as the file system is
capable of far higher bandwidth.</p>
<figure class="align-default" id="id8">
<img alt="Performance report Details - OpenMP" src="../_images/Perf-reports-6.png" />
<figcaption>
<p><span class="caption-text">Fig. 7 - Performance report Details - OpenMP</span><a class="headerlink" href="#id8" title="Link to this image"></a></p>
</figcaption>
</figure>
<p>The OpenMP
(threads) detail report is of little use for FVCOM as it is a single
threaded put MPI application. The same division as for MPI is relevant
here computation and synchronisation. In OpenMP which used shared
memory there is no transfer of data as all is in the same memory, but
access control is very important. Hence synchronisation can make up a
fraction of the time. False sharing is thing to look out for here when
developing multi threaded programs. It’s easy to forget that while
processor address individual bytes the cache is 64 bytes chunks of
memory that might overlap with another thread in another core and
cache line.</p>
<figure class="align-default" id="id9">
<img alt="Performance report Details - Memory" src="../_images/Perf-reports-7.png" />
<figcaption>
<p><span class="caption-text">Fig. 8 - Performance report Details - Memory</span><a class="headerlink" href="#id9" title="Link to this image"></a></p>
</figcaption>
</figure>
<p>The Memory detail report show the amount of memory used, mean and peak. As for
FVCOM with the input model in question it uses only 22% of the nodes’ memory.</p>
<p>It does unfortunately not give any information about strided or random
access. Even scalar operation can exhibit nice strided access. Any
form of random access can kill any performance. Accessing bytes at 100
nm access time (for normal DDR memory) effectively run the processing
speed at 10 MHz frequency.</p>
</section>
</section>
<section id="arm-forge-map-tool">
<h2>ARM forge Map tool<a class="headerlink" href="#arm-forge-map-tool" title="Link to this heading"></a></h2>
<p>The modules and settings are the same as for the performance reporter, the map tool is
ready to use. This is a tool that let you dig deeper into the application behavior.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">map</span> <span class="o">--</span><span class="n">profile</span> <span class="n">mpirun</span> <span class="o">&lt;</span><span class="n">your</span> <span class="n">program</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>The map tool is a more extensive tool than performance reporter. To start using the map tool
please read the <a class="reference external" href="https://developer.arm.com/documentation/101136/22-1-3/MAP">instructions and the manual</a>.</p>
<p>It comes with a nice GUI to analyse the logged data.</p>
<p>While not a direct performance tool the Arm-forge module also make the DDT (debugger) tool available.</p>
</section>
<section id="intel-advisor">
<h2>Intel Advisor<a class="headerlink" href="#intel-advisor" title="Link to this heading"></a></h2>
<section id="id1">
<h3>Introduction<a class="headerlink" href="#id1" title="Link to this heading"></a></h3>
<p>I order to get even more insight of your application with respect to
code generated (vector instructions, vectorised loops etc),
performance and memory access the tool Intel Advisor come in handy.</p>
<p>It’s very good for investigating how the compiler generated vector
code and also providing hints about vectorisation. It can also provide
information about memory access, like striding type.</p>
<p>It can record memory bandwidth and flops which is used to make a
<em>roof-line model</em>.  Please read about the
<a class="reference external" href="https://en.wikipedia.org/wiki/Roofline_model">roof-line model</a>.
if you are unfamiliar with it.</p>
<p>This case study does not go into depth on how to understand the
advisor tool, this is far better covered in the Intel tools
<a class="reference external" href="https://www.intel.com/content/www/us/en/resources-documentation/developer.html">documentation</a>
where they also provide a nice selection of tutorials.</p>
</section>
<section id="running-and-collecting">
<h3>Running and collecting<a class="headerlink" href="#running-and-collecting" title="Link to this heading"></a></h3>
<p>The GUI can be used to set up, launch, control and analyse the application. However,
it’s simpler to collect data within a batch job.
When running MPI jobs it’s only needed to run a single executable as they are all the same.
A project directory need to be created before command line collection can be initiated.</p>
<p>The commands that used to collect data for FVCOM in the batch job are when using OpenMPI:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>module load Advisor/2019_update5

advdir=$(dirname $(which advixe-cl))
mpirun -np 1  $advdir/advixe-cl -project-dir /cluster/work/support/olews/FVCOM_build/MATNOC-iompi/PO3/fvcom3   --collect survey -- ./fvcom.bin --casename=$RUN : -np 1023  ./fvcom.bin --casename=$RUN  &gt; $RUN_DIR/log-${SLURM_JOBID}.out
</pre></div>
</div>
<p>An absolute path for mpirun arguments is needed, either full path or relative.
The project directory is also given with full path. This directory need to be present before
the collection begin.</p>
<p>When survey has been run <em>tripcounts</em> and <em>flops</em> can be collected.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>module load Advisor/2019_update5

advdir=$(dirname $(which advixe-cl))
mpirun -np 1  $advdir/advixe-cl -project-dir /cluster/work/support/olews/FVCOM_build/MATNOC-iompi/PO3/fvcom3   --collect tripcounts -flop -- ./fvcom.bin --casename=$RUN : -np 1023  ./fvcom.bin --casename=$RUN  &gt; $RUN_DIR/log-${SLURM_JOBID}.out
</pre></div>
</div>
<p>Memory access can be collected using the <em>map</em> keyword.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>module load Advisor/2019_update5

advdir=$(dirname $(which advixe-cl))
mpirun -np 1  $advdir/advixe-cl -project-dir /cluster/work/support/olews/FVCOM_build/MATNOC-iompi/PO3/fvcom3   --collect map -flop -- ./fvcom.bin --casename=$RUN : -np 1023  ./fvcom.bin --casename=$RUN  &gt; $RUN_DIR/log-${SLURM_JOBID}.out
</pre></div>
</div>
<p>Both <em>tripcounts</em> and <em>map</em> increase the run time significantly,
remember to increase the Slurm run time.</p>
</section>
<section id="display-survey">
<h3>Display Survey<a class="headerlink" href="#display-survey" title="Link to this heading"></a></h3>
<p>To display the collected data please start the Advisor GUI tool using (remember to
log in using ssh -Y, so the login nodes have connection to your X11 terminal):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">advixe</span><span class="o">-</span><span class="n">gui</span> <span class="o">&amp;</span>
</pre></div>
</div>
<p>Open the project file and report file on rank0 (we run the collection on rank0).</p>
<figure class="align-default">
<img alt="../_images/Advisor-1.png" src="../_images/Advisor-1.png" />
</figure>
<p>The fist screen show en overview of the run, elapsed time, time in vector and scalar code.
In addition Gflops/s for Floating point &amp; integer and some CPU cache data load.
The fact that only 37.5% of the CPU time is spent executing vector instructions tells
us that the compiler did not manage to vectorise the loops as often as we would hope for.</p>
</section>
<section id="display-roof-line-model">
<h3>Display Roof-line model<a class="headerlink" href="#display-roof-line-model" title="Link to this heading"></a></h3>
<p>By clicking at the vertical stripe marked “roofline” the obtained
roof-line model of the application is displayed. It shows us
graphically how the application map out on a memory bandwidth vs
performance scale, see link to <em>roof-line model</em> above.</p>
<figure class="align-default">
<img alt="../_images/Advisor-2.png" src="../_images/Advisor-2.png" />
</figure>
<p>The circles are all located at the memory bandwidth
line and left the regions where the application is compute bound. This
is another illustration that the application performance is limited by
the memory bandwidth. The two colours identifies scalar (blue) and
vector (orange) performance.</p>
<p>The Advisor can also generated some recommendations that can be helpful.</p>
<figure class="align-default">
<img alt="../_images/Advisor-6.png" src="../_images/Advisor-6.png" />
</figure>
</section>
<section id="display-memory-access">
<h3>Display Memory access<a class="headerlink" href="#display-memory-access" title="Link to this heading"></a></h3>
<figure class="align-default">
<img alt="../_images/Advisor-7.png" src="../_images/Advisor-7.png" />
</figure>
<p>The map collection will record memory accesses and
lump them into categories for unit, constant and variable stride. It’s
well known that variable stride is very bad for performance. By providing
references to the source code it’s possible to review the code and see if it’s
possible to rewrite or do any changes that will improve performance.</p>
</section>
<section id="display-memory-dependencies">
<h3>Display memory dependencies<a class="headerlink" href="#display-memory-dependencies" title="Link to this heading"></a></h3>
<figure class="align-default">
<img alt="../_images/Advisor-8.png" src="../_images/Advisor-8.png" />
</figure>
<p>The dependency collection (takes very long time 20-100x
normal run time) record variable that reuse same variables,
e.g. memory location and potential race condition and sharing. The
compiler need to take action and generate code that places locks and
semaphores on such variables. This can have significant impact on
performance.</p>
</section>
<section id="program-efficiency">
<h3>Program efficiency<a class="headerlink" href="#program-efficiency" title="Link to this heading"></a></h3>
<p>The Advisor can calculate a total performance of the complete run:</p>
<figure class="align-default">
<img alt="../_images/Advisor-4.png" src="../_images/Advisor-4.png" />
</figure>
<p>The number is discouraging, 0.46 Gflops/s. A single
core can perform the following with two vector units at 256 bits
each : 2.5 GHz * 256 bits (4 double,64 bits) * 2 (two vector units) =
20 Gflops/s or using Fuse multiply add to get twice the performance at
40 Gflops/s. For single precision 32 bits the numbers can be
multiplied by two.</p>
<p>Using the most conservative numbers for double precision and not fused
multiply add (20 Gflops/s) we get 0.46 / 20 = 2.3% of the theoretical
performance.</p>
<p>This performance is not unusual for scientific code of this type. We
saw early on that only a fraction of the time (68.6%) was spent in CPU
time, of that time only a fraction was spent computing (35.9 + 0.3 =
36.2%). Combining this we arrive at 0.686*0.36.2=0.248 or 25% of the
time was spent computing.</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../jobs/internet-login-compute-nodes.html" class="btn btn-neutral float-left" title="Login nodes:" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../code_development/guides_llm.html" class="btn btn-neutral float-right" title="Running LLM Models in a Cluster Environment" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2026, Sigma2/NRIS. Text shared under CC-BY 4.0 license.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>