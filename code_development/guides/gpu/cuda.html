

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Using CUDA in C &mdash; Sigma2 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-design.min.css?v=95c83b7e" />
      <link rel="stylesheet" type="text/css" href="../../../_static/nris.css?v=69e7a171" />
      <link rel="stylesheet" type="text/css" href="../../../_static/universal-navbar.css" />
      <link rel="stylesheet" type="text/css" href="../../../_static/statuspal.css" />

  
    <link rel="shortcut icon" href="../../../_static/nris.ico"/>
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../../../_static/doctools.js?v=9a2dae69"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script async="async" src="https://siteimproveanalytics.com/js/siteanalyze_6036825.js"></script>
      <script src="../../../_static/design-tabs.js?v=f930bc37"></script>
      <script src="../../../_static/statuspal_widget.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">
<!-- Send url to parent when displayed as iframe -->
<script>
    const valid_orign_url = "https://www.sigma2.no"
    window.addEventListener('message', function(event) {
        if (event.data === 'getDocumentationIframeUrl' && event.origin.startsWith(valid_orign_url)) {
            // path only (/path/example.html)
            const path = window.location.pathname
            // query string (including the initial ? symbol)
            const search = window.location.search
            // Returns the hash (including the initial # symbol)
            const hash = window.location.hash
            const newUrl = path + search + hash;
            event.source.postMessage(newUrl, event.origin)
        }
    })

</script>

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            Sigma2/NRIS documentation
              <img src="../../../_static/NRIS Logo.svg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Policies</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../code-of-conduct.html">Code of Conduct</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Getting help</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_help/support_line.html">Getting help</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_help/extended_support.html">Extended support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_help/faq.html">Frequently asked questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_help/how_to_write_good_support_requests.html">Writing good support requests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_help/qa-sessions.html">Open Question &amp; Answer Sessions for All Users</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_help/lost_forgotten_password.html">Lost, expiring or changing passwords</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_help/two_factor_authentication.html">One-time-pad (OTP) / Two-factor authentication</a></li>
<li class="toctree-l1"><a class="reference external" href="https://www.sigma2.no/project-leader-handbook">Project Leader Support</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Training</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../training/events.html">Training events</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../training/notes_qa.html">Questions, Answers and Feedbacks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../training/past_training.html">An overview over training events in the past</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../training/videos.html">Training Video Archives</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../training/short_instructions.html">Short Instructions Video Archives</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../training/material.html">Training materials</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started/getting_started.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started/opslog.html">Status and maintenance of systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started/applying_account.html">How do I get an account?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started/applying_resources.html">Applying for computing and storage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started/file_transfer.html">File transfer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started/editing_files.html">Editing files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../vs_code/connect_to_server.html">Connecting to a system with Visual Studio Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started/ssh.html">SSH</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started/ssh.html#common-ssh-errors">Common SSH errors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started/ood.html">Open OnDemand</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started/R.html">First R calculation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Files, storage and backup</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../files_storage/nird_lmd.html">NIRD</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../files_storage/clusters.html">Storage areas on HPC clusters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../files_storage/quota.html">Storage quota</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../files_storage/backup.html">Backup on Betzy, Fram, Saga, and NIRD</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../files_storage/sharing_files.html">Data handling and storage policy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../files_storage/performance.html">Optimizing storage performance</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">HPC usage</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../hpc_machines/migration2metacenter.html">Migration to an NRIS HPC machine</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../computing/responsible-use.html">Using shared resources responsibly</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../jobs/overview.html">Running jobs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../jobs/internet-login-compute-nodes.html">Login nodes:</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../jobs/internet-login-compute-nodes.html#compute-nodes">Compute nodes:</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../computing/tuning-applications.html">Tuning applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guides_llm.html">Running LLM Models in a Cluster Environment</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Compute resources</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../hpc_machines/hardware_overview.html">Overview over our machines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../hpc_machines/betzy.html">Betzy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../hpc_machines/fram.html">Fram</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../hpc_machines/olivia.html">Olivia</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../hpc_machines/saga.html">Saga</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../hpc_machines/lumi.html">LUMI</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Software</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../software/modulescheme.html">Software module scheme</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../software/installed_software.html">Installed software</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../software/userinstallsw.html">Installing software as user</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../software/appguides.html">Application guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../software/licenses.html">Licence and access policies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../software/eessi.html">EESSI</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Additional services</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../nird_archive/sandbox-user-guide.html">NIRD Research Data Archive Sandbox (NIRD RDA sandbox)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nird_archive/user-guide.html">NIRD Research Data Archive (NIRD RDA)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nird_toolkit/overview.html">NIRD Toolkit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nird_service_platform/overview_nird_service_platform.html">NIRD Service Platform</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../services/easydmp-user-documentation.html">EasyDMP User Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_help/course_resources.html">CRaaS - Course Resources as a Service</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Code development and tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../overview.html">Code development and tutorials</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Sigma2/NRIS documentation</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Using CUDA in C</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="using-cuda-in-c">
<span id="cuda-c"></span><h1>Using CUDA in C<a class="headerlink" href="#using-cuda-in-c" title="Link to this heading"></a></h1>
<p>This example demonstrates:</p>
<ol class="arabic simple">
<li><p>how to compile a simple CUDA program</p></li>
<li><p>how to request GPU resources and run the program</p></li>
<li><p>how to monitor the GPU utilization</p></li>
</ol>
<p>In this example we will use <a class="reference external" href="https://en.wikipedia.org/wiki/CUDA">CUDA</a> to
facilitate offloading of a simple vector addition to be performed by a GPU,
and we will try to verify that the code is <em>actually</em> executed on the device.
We will compile and run the following code on Saga:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cuda.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cuda_runtime_api.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;math.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>

<span class="c1">// CUDA kernel, callable from host due to `__global__`</span>
<span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">add</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Calculate the array index of this thread</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">c</span><span class="p">[</span><span class="n">id</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">[</span><span class="n">id</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="p">[</span><span class="n">id</span><span class="p">];</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="n">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">argv</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;ENTER MAIN</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// Number of elements to compute over</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">num_elements</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1000000</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Allocate memory that can be accessed both on host and device</span>
<span class="w">    </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">a</span><span class="p">;</span>
<span class="w">    </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="p">;</span>
<span class="w">    </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">c</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// Should ideally catch errors here, but skip for brevity</span>
<span class="w">    </span><span class="n">cudaMallocManaged</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">num_elements</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>
<span class="w">    </span><span class="n">cudaMallocManaged</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">num_elements</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>
<span class="w">    </span><span class="n">cudaMallocManaged</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">num_elements</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>

<span class="w">    </span><span class="c1">// Fill our input arrays, on host, with some data to calculate</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">num_elements</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sinf</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sinf</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<span class="w">        </span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cosf</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cosf</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Define how many threads to launch on CUDA device</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">block_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1024</span><span class="p">;</span><span class="w"> </span><span class="c1">// Number of threads in each thread block</span>
<span class="w">    </span><span class="c1">// Number of thread blocks in a grid</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">grid_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="n">ceil</span><span class="p">((</span><span class="kt">float</span><span class="p">)</span><span class="w"> </span><span class="n">num_elements</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">block_size</span><span class="p">);</span>
<span class="w">	</span>
<span class="w">    </span><span class="c1">// Call CUDA kernel to run on device</span>
<span class="w">    </span><span class="n">add</span><span class="o">&lt;&lt;&lt;</span><span class="n">grid_size</span><span class="p">,</span><span class="w"> </span><span class="n">block_size</span><span class="o">&gt;&gt;&gt;</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">num_elements</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// Wait for computation before doing anything with data on host</span>
<span class="w">    </span><span class="n">cudaDeviceSynchronize</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Should print 1.0 at all entries</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;c[0]  : %f</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;c[1]  : %f</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;c[42] : %f</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">[</span><span class="mi">42</span><span class="p">]);</span>
<span class="w">	</span>
<span class="w">    </span><span class="c1">// Free memory</span>
<span class="w">    </span><span class="n">cudaFree</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
<span class="w">    </span><span class="n">cudaFree</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
<span class="w">    </span><span class="n">cudaFree</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>

<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;EXIT SUCCESS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p><a class="reference download internal" download="" href="../../../_downloads/69c5e1976eb0a6fb71e1669d25432187/vec_add_cuda.cu"><code class="xref download docutils literal notranslate"><span class="pre">vec_add_cuda.cu</span></code></a></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The purpose of this example is <em>not</em> to understand the details in the code snippet
above, but rather to have a working code example that we can compile, run and verify
on a GPU.</p>
</div>
<section id="step-1-compiling-the-code">
<h2>Step 1: Compiling the code<a class="headerlink" href="#step-1-compiling-the-code" title="Link to this heading"></a></h2>
<p>In order to compile this code we need a CUDA-aware compiler, and on Saga we get this
by loading a <code class="docutils literal notranslate"><span class="pre">CUDA</span></code> module (choosing here the most recent version at the time of writing):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">[me@login.SAGA]$ </span>module<span class="w"> </span>load<span class="w"> </span>CUDA/11.1.1-GCC-10.2.0
</pre></div>
</div>
<p>After the module is loaded you should have the <code class="docutils literal notranslate"><span class="pre">nvcc</span></code> CUDA compiler available:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">[me@login.SAGA]$ </span>nvcc<span class="w"> </span>--version
<span class="go">nvcc: NVIDIA (R) Cuda compiler driver</span>
<span class="go">Copyright (c) 2005-2020 NVIDIA Corporation</span>
<span class="go">Built on Mon_Oct_12_20:09:46_PDT_2020</span>
<span class="go">Cuda compilation tools, release 11.1, V11.1.105</span>
<span class="go">Build cuda_11.1.TC455_06.29190527_0</span>
</pre></div>
</div>
<p>We can now compile the code with the following command (never mind optimization flags
etc, they are not important at this point):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">[me@login.SAGA]$ </span>nvcc<span class="w"> </span>vec_add_cuda.cu<span class="w"> </span>-o<span class="w"> </span>vec_add_cuda
</pre></div>
</div>
<p>This command should hopefully finish without any error/warning. We can try to run the
resulting executable (which we called <code class="docutils literal notranslate"><span class="pre">vec_add_cuda</span></code>):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">[me@login.SAGA]$ </span>./vec_add_cuda
<span class="go">ENTER MAIN</span>
<span class="go">Segmentation fault (core dumped)</span>
</pre></div>
</div>
<p>But it will fail because we are here still running on the <code class="docutils literal notranslate"><span class="pre">login</span></code> node, and there are
no GPU hardware and drivers available here. The next step is thus to request GPU resources
for running our program.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In order to run a CUDA program you must have CUDA hardware drivers installed on the
machine. On Saga, these are <em>only</em> available on the GPU compute nodes, <em>not</em> on the
login nodes. However, the drivers are not necessary for the compilation step (only the
CUDA library, which comes with <code class="docutils literal notranslate"><span class="pre">module</span> <span class="pre">load</span> <span class="pre">CUDA/...</span></code>), so this can be done on the login node.</p>
</div>
</section>
<section id="step-2-running-the-code">
<h2>Step 2: Running the code<a class="headerlink" href="#step-2-running-the-code" title="Link to this heading"></a></h2>
<p>We will first test the code in an interactive session, so we ask for a single GPU:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">[me@login.SAGA]$ </span>salloc<span class="w"> </span>--nodes<span class="o">=</span><span class="m">1</span><span class="w"> </span>--gpus<span class="o">=</span><span class="m">1</span><span class="w"> </span>--time<span class="o">=</span><span class="m">0</span>:10:00<span class="w"> </span>--mem<span class="o">=</span>1G<span class="w"> </span>--partition<span class="o">=</span>accel<span class="w"> </span>--account<span class="o">=</span>&lt;your-account&gt;
<span class="go">salloc: Pending job allocation 4320527</span>
<span class="go">salloc: job 4320527 queued and waiting for resources</span>
<span class="go">salloc: job 4320527 has been allocated resources</span>
<span class="go">salloc: Granted job allocation 4320527</span>
<span class="go">salloc: Waiting for resource configuration</span>
<span class="go">salloc: Nodes c7-8 are ready for job</span>
</pre></div>
</div>
<p>Remember to load the <code class="docutils literal notranslate"><span class="pre">CUDA</span></code> module if not already loaded from Step 1. You can also verify
that you actually have access to a GPU using the <code class="docutils literal notranslate"><span class="pre">nvidia-smi</span></code> command. If all goes well,
your program should now  run and exit successfully:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">[me@c7-8]$ </span>./vec_add_cuda
<span class="go">ENTER MAIN</span>
<span class="go">c[0]  : 1.000000</span>
<span class="go">c[1]  : 1.000000</span>
<span class="go">c[42] : 1.000000</span>
<span class="go">EXIT SUCCESS</span>
</pre></div>
</div>
<p>We here see the expected output of $c[i] = sin^2(i) + cos^2(i) = 1$ for any $i$, which
means that the code runs correctly.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For this particular example we have actually now already verified that the code was executed
<strong>on the GPU</strong>. As the code is written, there is no “fallback” implementation that runs
on the CPU in case no GPU is found, which means that <code class="docutils literal notranslate"><span class="pre">EXIT</span> <span class="pre">SUCCESS</span></code> == “the code executed
on the GPU”.</p>
</div>
</section>
<section id="step-3-monitor-the-gpu-utilization">
<h2>Step 3: Monitor the GPU utilization<a class="headerlink" href="#step-3-monitor-the-gpu-utilization" title="Link to this heading"></a></h2>
<p>We will now try to capture some stats from the execution using the <code class="docutils literal notranslate"><span class="pre">nvidia-smi</span></code> tool
to verify that we were able to utilize a few percent of the GPUs capacity. To get a
reasonable reading from this tool we need an application that runs for at least a few
seconds, so we will first make the following change to our source code:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="hll"><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">100000</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span class="w">        </span><span class="c1">// Call CUDA kernel to run on device</span>
<span class="w">        </span><span class="n">add</span><span class="o">&lt;&lt;&lt;</span><span class="n">grid_size</span><span class="p">,</span><span class="w"> </span><span class="n">block_size</span><span class="o">&gt;&gt;&gt;</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">num_elements</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// Wait for computation before doing anything with data on host</span>
<span class="w">        </span><span class="n">cudaDeviceSynchronize</span><span class="p">();</span>
<span class="hll"><span class="w">    </span><span class="p">}</span>
</span></pre></div>
</div>
<p><a class="reference download internal" download="" href="../../../_downloads/1b97dd40682c2ab09e28f64b698eff77/loop_add_cuda.cu"><code class="xref download docutils literal notranslate"><span class="pre">loop_add_cuda.cu</span></code></a></p>
<p>i.e. we loop over the vector addition 100 000 times. This should hopefully give sufficient
run time to be picked up by our tool. We then compile and run our new code with the following
job script:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1">#SBATCH --job-name=CUDA-test</span>
<span class="c1">#SBATCH --account=nn&lt;XXXX&gt;k</span>
<span class="c1">#SBATCH --time=05:00</span>
<span class="c1">#SBATCH --mem-per-cpu=1G</span>
<span class="c1">#SBATCH --qos=devel</span>
<span class="c1">#SBATCH --partition=accel</span>
<span class="c1">#SBATCH --gpus=1</span>

<span class="c1">## Set up job environment:</span>
<span class="nb">set</span><span class="w"> </span>-o<span class="w"> </span>errexit<span class="w">  </span><span class="c1"># Exit the script on any error</span>
<span class="nb">set</span><span class="w"> </span>-o<span class="w"> </span>nounset<span class="w">  </span><span class="c1"># Treat any unset variables as an error</span>

module<span class="w"> </span>--quiet<span class="w"> </span>purge<span class="w">  </span><span class="c1"># Reset the modules to the system default</span>
module<span class="w"> </span>load<span class="w"> </span>CUDA/11.1.1-GCC-10.2.0
module<span class="w"> </span>list

<span class="c1"># Compile our code</span>
nvcc<span class="w"> </span>loop_add_cuda.cu<span class="w"> </span>-o<span class="w"> </span>loop_add_cuda

<span class="c1"># Run our computation</span>
./loop_add_cuda

<span class="nb">exit</span><span class="w"> </span><span class="m">0</span>
</pre></div>
</div>
<p><a class="reference download internal" download="" href="../../../_downloads/279a661df1a778477720a8abbad526a0/run.sh"><code class="xref download docutils literal notranslate"><span class="pre">run.sh</span></code></a></p>
<p>Submit the job using <code class="docutils literal notranslate"><span class="pre">sbatch</span></code> (remember to set the <code class="docutils literal notranslate"><span class="pre">--account</span></code> option, and note that we are
back on the <code class="docutils literal notranslate"><span class="pre">login</span></code> node):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">[me@login.SAGA]$ </span>sbatch<span class="w"> </span>run.sh
<span class="go">Submitted batch job 4320512</span>
</pre></div>
</div>
<p>Wait for the job to finish and verify from the <code class="docutils literal notranslate"><span class="pre">slurm-xxxxx.out</span></code> file that the
calculation still finished successfully, and that it ran for at least a few seconds.</p>
<p>We can then add the following lines to the script in order to monitor the GPU
utilization using <code class="docutils literal notranslate"><span class="pre">nvidia-smi</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compile our code</span>
nvcc<span class="w"> </span>loop_add_cuda.cu<span class="w"> </span>-o<span class="w"> </span>loop_add_cuda

<span class="hll"><span class="c1"># Setup monitoring</span>
</span><span class="hll">nvidia-smi<span class="w"> </span>--query-gpu<span class="o">=</span>timestamp,utilization.gpu,utilization.memory<span class="w"> </span><span class="se">\</span>
</span><span class="hll"><span class="w">           </span>--format<span class="o">=</span>csv<span class="w"> </span>--loop<span class="o">=</span><span class="m">1</span><span class="w"> </span>&gt;<span class="w"> </span><span class="s2">&quot;monitor-</span><span class="nv">$SLURM_JOB_ID</span><span class="s2">.csv&quot;</span><span class="w"> </span><span class="p">&amp;</span>
</span><span class="hll"><span class="nv">NVIDIA_MONITOR_PID</span><span class="o">=</span><span class="nv">$!</span><span class="w">  </span><span class="c1"># Capture PID of monitoring process</span>
</span>
<span class="c1"># Run our computation</span>
./loop_add_cuda

<span class="hll"><span class="c1"># After computation stop monitoring</span>
</span><span class="hll"><span class="nb">kill</span><span class="w"> </span>-SIGINT<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$NVIDIA_MONITOR_PID</span><span class="s2">&quot;</span>
</span>
<span class="nb">exit</span><span class="w"> </span><span class="m">0</span>
</pre></div>
</div>
<p><a class="reference download internal" download="" href="../../../_downloads/69b8d69611b521fa3cf306827b36ef95/monitor.sh"><code class="xref download docutils literal notranslate"><span class="pre">monitor.sh</span></code></a></p>
<p>Submit the job:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">[me@login.SAGA]$ </span>sbatch<span class="w"> </span>monitor.sh
<span class="go">Submitted batch job 4320513</span>
</pre></div>
</div>
<p>Wait for the job to complete and inspect the <code class="docutils literal notranslate"><span class="pre">monitor-xxxx.csv</span></code> file we just created:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">[me@login.SAGA]$ </span>cat<span class="w"> </span>monitor-4320513.csv
<span class="go">timestamp, utilization.gpu [%], utilization.memory [%]</span>
<span class="go">2021/11/03 21:42:44.210, 0 %, 0 %</span>
<span class="go">2021/11/03 21:42:45.211, 82 %, 76 %</span>
<span class="go">2021/11/03 21:42:46.211, 82 %, 69 %</span>
<span class="go">2021/11/03 21:42:47.211, 82 %, 69 %</span>
</pre></div>
</div>
<p>We see here that the GPU utilization reached 82% of the GPUs capacity.</p>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Sigma2/NRIS. Text shared under CC-BY 4.0 license.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>