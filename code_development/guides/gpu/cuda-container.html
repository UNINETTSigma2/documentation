

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BYO CUDA environment with containers &mdash; Sigma2 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-design.min.css?v=95c83b7e" />
      <link rel="stylesheet" type="text/css" href="../../../_static/nris.css?v=69e7a171" />
      <link rel="stylesheet" type="text/css" href="../../../_static/universal-navbar.css" />
      <link rel="stylesheet" type="text/css" href="../../../_static/statuspal.css" />

  
    <link rel="shortcut icon" href="../../../_static/nris.ico"/>
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../../../_static/doctools.js?v=9a2dae69"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script async="async" src="https://siteimproveanalytics.com/js/siteanalyze_6036825.js"></script>
      <script src="../../../_static/design-tabs.js?v=f930bc37"></script>
      <script src="../../../_static/statuspal_widget.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">
<!-- Send url to parent when displayed as iframe -->
<script>
    const valid_orign_url = "https://www.sigma2.no"
    window.addEventListener('message', function(event) {
        if (event.data === 'getDocumentationIframeUrl' && event.origin.startsWith(valid_orign_url)) {
            // path only (/path/example.html)
            const path = window.location.pathname
            // query string (including the initial ? symbol)
            const search = window.location.search
            // Returns the hash (including the initial # symbol)
            const hash = window.location.hash
            const newUrl = path + search + hash;
            event.source.postMessage(newUrl, event.origin)
        }
    })

</script>

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            Sigma2/NRIS documentation
              <img src="../../../_static/NRIS Logo.svg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Policies</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../code-of-conduct.html">Code of Conduct</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Getting help</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_help/support_line.html">Getting help</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_help/extended_support.html">Extended support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_help/faq.html">Frequently asked questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_help/how_to_write_good_support_requests.html">Writing good support requests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_help/qa-sessions.html">Open Question &amp; Answer Sessions for All Users</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_help/lost_forgotten_password.html">Lost, expiring or changing passwords</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_help/two_factor_authentication.html">One-time-pad (OTP) / Two-factor authentication</a></li>
<li class="toctree-l1"><a class="reference external" href="https://www.sigma2.no/project-leader-handbook">Project Leader Support</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Training</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../training/events.html">Training events</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../training/notes_qa.html">Questions, Answers and Feedbacks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../training/past_training.html">An overview over training events in the past</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../training/videos.html">Training Video Archives</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../training/short_instructions.html">Short Instructions Video Archives</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../training/material.html">Training materials</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started/getting_started.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started/opslog.html">Status and maintenance of systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started/applying_account.html">How do I get an account?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started/applying_resources.html">Applying for computing and storage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started/file_transfer.html">File transfer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started/editing_files.html">Editing files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../vs_code/connect_to_server.html">Connecting to a system with Visual Studio Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started/ssh.html">SSH</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started/ssh.html#common-ssh-errors">Common SSH errors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started/ood.html">Open OnDemand</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started/R.html">First R calculation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Files, storage and backup</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../files_storage/nird_lmd.html">NIRD</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../files_storage/clusters.html">Storage areas on HPC clusters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../files_storage/quota.html">Storage quota</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../files_storage/backup.html">Backup on Betzy, Fram, Saga, and NIRD</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../files_storage/sharing_files.html">Data handling and storage policy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../files_storage/performance.html">Optimizing storage performance</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">HPC usage</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../hpc_machines/migration2metacenter.html">Migration to an NRIS HPC machine</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../computing/responsible-use.html">Using shared resources responsibly</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../jobs/overview.html">Running jobs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../jobs/internet-login-compute-nodes.html">Login nodes:</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../jobs/internet-login-compute-nodes.html#compute-nodes">Compute nodes:</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../computing/tuning-applications.html">Tuning applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guides_llm.html">Running LLM Models in a Cluster Environment</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Compute resources</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../hpc_machines/hardware_overview.html">Overview over our machines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../hpc_machines/betzy.html">Betzy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../hpc_machines/fram.html">Fram</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../hpc_machines/olivia.html">Olivia</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../hpc_machines/saga.html">Saga</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../hpc_machines/lumi.html">LUMI</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Software</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../software/modulescheme.html">Software module scheme</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../software/installed_software.html">Installed software</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../software/userinstallsw.html">Installing software as user</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../software/appguides.html">Application guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../software/licenses.html">Licence and access policies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../software/eessi.html">EESSI</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Additional services</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../nird_archive/sandbox-user-guide.html">NIRD Research Data Archive Sandbox (NIRD RDA sandbox)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nird_archive/user-guide.html">NIRD Research Data Archive (NIRD RDA)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nird_toolkit/overview.html">NIRD Toolkit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nird_service_platform/overview_nird_service_platform.html">NIRD Service Platform</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../services/easydmp-user-documentation.html">EasyDMP User Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_help/course_resources.html">CRaaS - Course Resources as a Service</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Code development and tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../overview.html">Code development and tutorials</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Sigma2/NRIS documentation</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">BYO CUDA environment with containers</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="byo-cuda-environment-with-containers">
<span id="byo-cuda-container"></span><h1>BYO CUDA environment with containers<a class="headerlink" href="#byo-cuda-environment-with-containers" title="Link to this heading"></a></h1>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This example assumes basic knowledge on Singularity containers,
on the level presented in our container <a class="reference internal" href="../containers.html#running-containers"><span class="std std-ref">intro</span></a>.</p>
</div>
<p>This example demonstrates:</p>
<ol class="arabic simple">
<li><p>how to pull a CUDA container image from the NGC</p></li>
<li><p>how to build your CUDA application through the container environment</p></li>
<li><p>how to run your CUDA application through the container environment</p></li>
</ol>
<p>In this example we will use the same code as we used in the basic CUDA
<a class="reference internal" href="cuda.html#cuda-c"><span class="std std-ref">tutorial</span></a>, but we will try to build the code in a different
CUDA environment than what we currently have available on Saga. In particular,
we will fetch a container image with a <em>newer</em> version of CUDA from the Nvidia GPU
Cloud (<a class="reference external" href="https://catalog.ngc.nvidia.com/">NGC</a>).</p>
<p>First, let’s revisit the source code from the other example:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cuda.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cuda_runtime_api.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;math.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>

<span class="c1">// CUDA kernel, callable from host due to `__global__`</span>
<span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">add</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Calculate the array index of this thread</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">c</span><span class="p">[</span><span class="n">id</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">[</span><span class="n">id</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="p">[</span><span class="n">id</span><span class="p">];</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="n">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">argv</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;ENTER MAIN</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// Number of elements to compute over</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">num_elements</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1000000</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Allocate memory that can be accessed both on host and device</span>
<span class="w">    </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">a</span><span class="p">;</span>
<span class="w">    </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="p">;</span>
<span class="w">    </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">c</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// Should ideally catch errors here, but skip for brevity</span>
<span class="w">    </span><span class="n">cudaMallocManaged</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">num_elements</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>
<span class="w">    </span><span class="n">cudaMallocManaged</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">num_elements</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>
<span class="w">    </span><span class="n">cudaMallocManaged</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">num_elements</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>

<span class="w">    </span><span class="c1">// Fill our input arrays, on host, with some data to calculate</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">num_elements</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sinf</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sinf</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<span class="w">        </span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cosf</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cosf</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Define how many threads to launch on CUDA device</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">block_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1024</span><span class="p">;</span><span class="w"> </span><span class="c1">// Number of threads in each thread block</span>
<span class="w">    </span><span class="c1">// Number of thread blocks in a grid</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">grid_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="n">ceil</span><span class="p">((</span><span class="kt">float</span><span class="p">)</span><span class="w"> </span><span class="n">num_elements</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">block_size</span><span class="p">);</span>
<span class="w">	</span>
<span class="w">    </span><span class="c1">// Call CUDA kernel to run on device</span>
<span class="w">    </span><span class="n">add</span><span class="o">&lt;&lt;&lt;</span><span class="n">grid_size</span><span class="p">,</span><span class="w"> </span><span class="n">block_size</span><span class="o">&gt;&gt;&gt;</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">num_elements</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// Wait for computation before doing anything with data on host</span>
<span class="w">    </span><span class="n">cudaDeviceSynchronize</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Should print 1.0 at all entries</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;c[0]  : %f</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;c[1]  : %f</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;c[42] : %f</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">[</span><span class="mi">42</span><span class="p">]);</span>
<span class="w">	</span>
<span class="w">    </span><span class="c1">// Free memory</span>
<span class="w">    </span><span class="n">cudaFree</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
<span class="w">    </span><span class="n">cudaFree</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
<span class="w">    </span><span class="n">cudaFree</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>

<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;EXIT SUCCESS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p><a class="reference download internal" download="" href="../../../_downloads/69c5e1976eb0a6fb71e1669d25432187/vec_add_cuda.cu"><code class="xref download docutils literal notranslate"><span class="pre">vec_add_cuda.cu</span></code></a></p>
<section id="step-1-pull-container-image-from-the-ngc">
<h2>Step 1: Pull container image from the NGC<a class="headerlink" href="#step-1-pull-container-image-from-the-ngc" title="Link to this heading"></a></h2>
<p>We start by browsing the <a class="reference external" href="https://catalog.ngc.nvidia.com/containers">NGC</a> for a suitable
container image, which should be from the <a class="reference external" href="https://catalog.ngc.nvidia.com/orgs/nvidia/containers/cuda">CUDA</a>
collection. For development work (compilation etc) we should choose a tag with <code class="docutils literal notranslate"><span class="pre">devel</span></code>
in its name, but the CUDA version and operating system can be whatever you like.
We download one such container with the following command (this might take a few minutes):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">[me@login.SAGA]$ </span>singularity<span class="w"> </span>pull<span class="w"> </span>docker://nvcr.io/nvidia/cuda:11.4.0-devel-ubuntu20.04
<span class="go">INFO:    Converting OCI blobs to SIF format</span>
<span class="go">INFO:    Starting build...</span>
<span class="go">Getting image source signatures</span>
<span class="go">Copying blob 35807b77a593 done  </span>
<span class="go">Copying blob 2f02693dc068 done  </span>
<span class="go">Copying blob 903c09d5b94e done  </span>
<span class="go">Copying blob 205c053b80d7 done  </span>
<span class="go">Copying blob 3da463f4fa89 done  </span>
<span class="go">Copying blob 6ae79230f62a done  </span>
<span class="go">Copying blob 43b3e972ee6d done  </span>
<span class="go">Copying blob 93f128a4f293 done  </span>
<span class="go">Copying blob c8078b8bb166 done  </span>
<span class="go">Copying config c3f63d2c90 done  </span>
<span class="go">Writing manifest to image destination</span>
<span class="go">Storing signatures</span>
<span class="go">2021/11/03 22:40:19  info unpack layer: sha256:35807b77a593c1147d13dc926a91dcc3015616ff7307cc30442c5a8e07546283</span>
<span class="go">2021/11/03 22:40:20  info unpack layer: sha256:2f02693dc0685e3a6de01df36887f5d358f48a48886e688251ac3ef04c410362</span>
<span class="go">2021/11/03 22:40:20  info unpack layer: sha256:903c09d5b94ea239fc1a5a7fd909c3afe62912ce90c86c8924d57a2f71055d34</span>
<span class="go">2021/11/03 22:40:21  info unpack layer: sha256:205c053b80d7b029905054aac222afacbb17ec8266df623e0bcea36ce5d88d37</span>
<span class="go">2021/11/03 22:40:21  info unpack layer: sha256:3da463f4fa89a36aa543d72065de871d22072cd139e6e85b2fb7bd91473a4409</span>
<span class="go">2021/11/03 22:40:21  info unpack layer: sha256:6ae79230f62a71f8abb1c6aaefbaa48e6cf6f38a671ba511bf19678882d747c2</span>
<span class="go">2021/11/03 22:40:43  info unpack layer: sha256:43b3e972ee6de26010ac81c65aa5f37612caa6c1f0c9eb9c114f841f67e154a3</span>
<span class="go">2021/11/03 22:40:43  info unpack layer: sha256:93f128a4f293c7f83d182fda8740bb51ea5c1c7508c97f6b563e08c12c3fca07</span>
<span class="go">2021/11/03 22:41:12  info unpack layer: sha256:c8078b8bb1668a188a782de56e7d1e6faff012f45a932f1c43b145c2b61ea0d3</span>
<span class="go">INFO:    Creating SIF file...</span>
</pre></div>
</div>
<p>We should now have the following file in the current directory</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">[me@login.SAGA]$ </span>ls<span class="w"> </span>-lh
<span class="go">-rwxrwxr-x 1 me me_g 2.8G Nov  3 12:41 cuda_11.4.0-devel-ubuntu20.04.sif</span>
</pre></div>
</div>
<p>which is the Singularity image file. Notice the size (2.8G) of this image, and keep in
mind your <code class="docutils literal notranslate"><span class="pre">$HOME</span></code> disk quota of 20GiB.</p>
<p>Once we have the container image we can verify that we have the <code class="docutils literal notranslate"><span class="pre">nvcc</span></code> CUDA compiler
available inside it. First we check on the host (no modules load at this point):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">[me@login.SAGA]$ </span>nvcc<span class="w"> </span>--version
<span class="go">-bash: nvcc: command not found</span>
</pre></div>
</div>
<p>but if we run the same command <em>through</em> the container we should find a compiler:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">[me@login.SAGA]$ </span>singularity<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>cuda_11.4.0-devel-ubuntu20.04.sif<span class="w"> </span>nvcc<span class="w"> </span>--version
<span class="go">nvcc: NVIDIA (R) Cuda compiler driver</span>
<span class="go">Copyright (c) 2005-2021 NVIDIA Corporation</span>
<span class="go">Built on Sun_Aug_15_21:14:11_PDT_2021</span>
<span class="go">Cuda compilation tools, release 11.4, V11.4.120</span>
<span class="go">Build cuda_11.4.r11.4/compiler.30300941_0</span>
</pre></div>
</div>
<p>Notice the CUDA version, which is more recent than any currently supported module
on Saga (which is CUDA/11.1.1 at the time of writing).</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Container images are typically a few GiB in size, so you might want to keep your
containers in a project storage area to avoid filling up your limited <code class="docutils literal notranslate"><span class="pre">$HOME</span></code> disk quota.
Also beware that pulled images are cached, by default under <code class="docutils literal notranslate"><span class="pre">$HOME/.singularity/cache</span></code>.
This means that if you pull the same image twice, it will be immediately available from
the cache without downloading/building, but it also means that it will consume disk space.
To avoid this you can either add <code class="docutils literal notranslate"><span class="pre">--disable-cache</span></code> to the <code class="docutils literal notranslate"><span class="pre">pull</span></code> command, change the cache
directory with the <code class="docutils literal notranslate"><span class="pre">SINGULARITY_CACHEDIR</span></code> environment variable, or clean up the cache
regularly with <code class="docutils literal notranslate"><span class="pre">singularity</span> <span class="pre">cache</span> <span class="pre">clean</span></code>.</p>
</div>
</section>
<section id="step-2-compile-the-code-through-the-container-environment">
<h2>Step 2: Compile the code through the container environment<a class="headerlink" href="#step-2-compile-the-code-through-the-container-environment" title="Link to this heading"></a></h2>
<p>Now that we found a <code class="docutils literal notranslate"><span class="pre">nvcc</span></code> compiler inside the container, we can try to compile our code
<em>through</em> the container environment. In order to make this work we need to add one option
to the compilation command that we used <a class="reference internal" href="cuda.html#cuda-c"><span class="std std-ref">before</span></a>. In the “native” build on
Saga we did not have to specify the <code class="docutils literal notranslate"><span class="pre">gpu-architecture</span></code> that we compile for, as it was able
to pick that up automatically. In the container environment, however, the CUDA compiler
has not been set up with this information so we have to provide it as a compiler option,
which makes the full compilation string:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">nvcc</span> <span class="o">--</span><span class="n">gpu</span><span class="o">-</span><span class="n">architecture</span><span class="o">=</span><span class="n">sm_60</span> <span class="n">vec_add_cuda</span><span class="o">.</span><span class="n">cu</span> <span class="o">-</span><span class="n">o</span> <span class="n">vec_add_cuda</span>
</pre></div>
</div>
<p>and we just have to pass it to the <code class="docutils literal notranslate"><span class="pre">singularity</span> <span class="pre">exec</span></code> command:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">[me@login.SAGA]$ </span>singularity<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>--bind<span class="w"> </span><span class="nv">$PWD</span><span class="w"> </span>cuda_11.4.0-devel-ubuntu20.04.sif<span class="w"> </span>nvcc<span class="w"> </span>--gpu-architecture<span class="o">=</span>sm_60<span class="w"> </span>vec_add_cuda.cu<span class="w"> </span>-o<span class="w"> </span>vec_add_cuda
</pre></div>
</div>
<p>Notice also the <code class="docutils literal notranslate"><span class="pre">--bind</span> <span class="pre">$PWD</span></code> option, which makes sure that the files in the current directory
is visible to the container. The compilation should hopefully finish without any errors/warnings,
and there should now be a <code class="docutils literal notranslate"><span class="pre">vec_add_cuda</span></code> executable file in your current directory (also
accessible by the host, even if it was created from within the container).</p>
<p>This executable will however not run successfully on the login node, since there are no
GPUs available here. We thus have to request GPU resources through Slurm.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The origin of the <code class="docutils literal notranslate"><span class="pre">sm_60</span></code> architecture flag is a bit hard to explain, and you really need
to dig deep into the hardware specs to figure out the correct option here.
For our machines at NRIS we have:</p>
<ul class="simple">
<li><p>Saga: Nvidia Pascal (P100) - <code class="docutils literal notranslate"><span class="pre">sm_60</span></code></p></li>
<li><p>NIRD: Nvidia Volta (V100) - <code class="docutils literal notranslate"><span class="pre">sm_70</span></code></p></li>
<li><p>Betzy: Nvidia Ampere (A100) - <code class="docutils literal notranslate"><span class="pre">sm_80</span></code></p></li>
</ul>
</div>
</section>
<section id="step-3-run-the-code-through-the-container-environment">
<h2>Step 3: Run the code through the container environment<a class="headerlink" href="#step-3-run-the-code-through-the-container-environment" title="Link to this heading"></a></h2>
<p>We will test the code in an interactive session, so we ask for a single GPU:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">[me@login.SAGA]$ </span>salloc<span class="w"> </span>--nodes<span class="o">=</span><span class="m">1</span><span class="w"> </span>--gpus<span class="o">=</span><span class="m">1</span><span class="w"> </span>--time<span class="o">=</span><span class="m">0</span>:10:00<span class="w"> </span>--mem<span class="o">=</span>1G<span class="w"> </span>--partition<span class="o">=</span>accel<span class="w"> </span>--account<span class="o">=</span>&lt;your-account&gt;
<span class="go">salloc: Pending job allocation 4320527</span>
<span class="go">salloc: job 4320527 queued and waiting for resources</span>
<span class="go">salloc: job 4320527 has been allocated resources</span>
<span class="go">salloc: Granted job allocation 4320527</span>
<span class="go">salloc: Waiting for resource configuration</span>
<span class="go">salloc: Nodes c7-8 are ready for job</span>
</pre></div>
</div>
<p>Now, the CUDA environment inside the container is probably backward compatible with the
CUDA version on the cluster, so our newly created executable will <em>probably</em> run smoothly
even if we don’t run it through the container, but for the sake of consistency we will
launch the program with <code class="docutils literal notranslate"><span class="pre">singularity</span> <span class="pre">exec</span></code></p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">[me@c7-8]$ </span>singularity<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>--bind<span class="w"> </span><span class="nv">$PWD</span><span class="w"> </span>cuda_11.4.0-devel-ubuntu20.04.sif<span class="w"> </span>./vec_add_cuda
<span class="go">ENTER MAIN</span>
<span class="go">Segmentation fault</span>
</pre></div>
</div>
<p>The reason this failed is that Singularity has not been made aware of the GPU resources
on the host (kind of like the situation we had with <code class="docutils literal notranslate"><span class="pre">salloc</span> <span class="pre">--partition=accel</span></code> <em>without</em>
the <code class="docutils literal notranslate"><span class="pre">--gpus=1</span></code> option). The magic keyword to make this work in Singularity is <code class="docutils literal notranslate"><span class="pre">--nv</span></code>
(for Nvidia, for AMD GPUs the keyword is <code class="docutils literal notranslate"><span class="pre">--rocm</span></code>):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">[me@c7-8]$ </span>singularity<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>--nv<span class="w"> </span>--bind<span class="w"> </span><span class="nv">$PWD</span><span class="w"> </span>cuda_11.4.0-devel-ubuntu20.04.sif<span class="w"> </span>./vec_add_cuda
<span class="go">ENTER MAIN</span>
<span class="go">c[0]  : 1.000000</span>
<span class="go">c[1]  : 1.000000</span>
<span class="go">c[42] : 1.000000</span>
<span class="go">EXIT SUCCESS</span>
</pre></div>
</div>
<p>We have now successfully compiled and run a CUDA program <em>through</em> a container environment.</p>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Sigma2/NRIS. Text shared under CC-BY 4.0 license.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>